{% extends "base.html" %}

{% block title %}Settings - Stockbit Running Trade Scraper{% endblock %}

{% block content %}
<div class="container">
    <h1>Settings</h1>
    
    <!-- Token Management -->
    <!-- Token Management -->
    
    <!-- Current Session Details -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Current Session Details</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">Current Bearer Token to be used in script</label>
                <div class="input-group">
                    <input type="text" class="form-control font-monospace" id="current-token" readonly value="Loading..." style="background-color: #f8f9fa;">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('current-token')">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Current Cookies to be used in script</label>
                <div class="input-group">
                    <input type="text" class="form-control font-monospace" id="current-cookies" readonly value="Loading..." style="background-color: #f8f9fa;">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('current-cookies')">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#tokenDecoder" aria-expanded="false" aria-controls="tokenDecoder" onclick="decodeCurrentToken()">
                    <i class="bi bi-code-square"></i> Decode JWT
                </button>
                <button class="btn btn-primary" type="button" onclick="toggleUpdateForm()">
                    <i class="bi bi-pencil-square"></i> Update Token & Cookies
                </button>
            </div>

            <div class="collapse mt-3" id="tokenDecoder">
                <div class="card card-body bg-light border-info">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted small text-uppercase">Header</h6>
                            <pre id="jwt-header" class="bg-white p-2 border rounded small" style="max-height: 200px; overflow: auto;"></pre>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted small text-uppercase">Payload</h6>
                            <pre id="jwt-payload" class="bg-white p-2 border rounded small" style="max-height: 200px; overflow: auto;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Update (Hidden by default) -->
    <div class="card mt-4" id="update-credentials-card" style="display: none;">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-key"></i> Update Credentials</h5>
                <button type="button" class="btn-close btn-close-white" onclick="toggleUpdateForm()" aria-label="Close"></button>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>How to get your Bearer token:</strong>
                <ol>
                    <li>Login to <a href="https://stockbit.com/login" target="_blank">Stockbit.com</a> in your browser</li>
                    <li>Open Developer Tools (F12)</li>
                    <li>Go to the Network tab</li>
                    <li>Look for any API request (like to <code>exodus.stockbit.com</code>)</li>
                    <li>Find the <code>Authorization</code> header and copy the token (without the "Bearer " prefix)</li>
                </ol>
            </div>
            
            <div id="token-status-display" class="mb-3">
                <!-- will be filled by JS -->
            </div>
            
            <form id="token-form">
                <div class="mb-3">
                    <label for="bearer-token" class="form-label">Bearer Token:</label>
                    <textarea 
                        id="bearer-token" 
                        class="form-control" 
                        rows="4" 
                        placeholder="Paste your Bearer token here..."
                        required
                    ></textarea>
                    <small class="text-muted">
                        This is the JWT token from the Authorization header
                    </small>
                </div>
                
                <div class="mb-3">
                    <label for="cookies" class="form-label">Cookies (Optional, for Orderbook streaming):</label>
                    <textarea 
                        id="cookies" 
                        class="form-control" 
                        rows="3" 
                        placeholder="Paste your Cookie header here (e.g., from Postman)..."
                    ></textarea>
                    <small class="text-muted">
                        <strong>Optional but recommended for stable WebSocket connections.</strong> Copy the entire Cookie header from Postman or Browser DevTools. This helps keep orderbook connections alive for hours.
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Token & Cookies
                </button>
            </form>
        </div>
    </div>
    
    <!-- Job Defaults -->
    <div class="card mt-4">
        <div class="card-header">
            <h3>Job Defaults</h3>
        </div>
        <div class="card-body">
            <form id="defaults-form">
                <div class="mb-3">
                    <label for="default-delay" class="form-label">
                        Delay Between Requests (seconds):
                    </label>
                    <input 
                        type="number" 
                        id="default-delay" 
                        class="form-control" 
                        value="3" 
                        min="0" 
                        step="0.5"
                    >
                    <small class="text-muted">
                        Wait time between each API request (helps avoid rate limiting)
                    </small>
                </div>
                
                <div class="mb-3">
                    <label for="default-limit" class="form-label">
                        Records Per Request:
                    </label>
                    <input 
                        type="number" 
                        id="default-limit" 
                        class="form-control" 
                        value="50" 
                        min="1" 
                        max="200"
                    >
                    <small class="text-muted">
                        Number of records to fetch per request (max 200)
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Defaults
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// load token status on page load
document.addEventListener('DOMContentLoaded', () => {
    checkTokenStatus();
    loadDefaults();
});

function checkTokenStatus() {
    fetch('/api/token/status')
        .then(res => res.json())
        .then(data => {
            const statusDiv = document.getElementById('token-status-display');
            
            // Populate current session details
            const tokenInput = document.getElementById('current-token');
            const cookiesInput = document.getElementById('current-cookies');
            
            if (data.token) {
                tokenInput.value = data.token;
            } else {
                tokenInput.value = 'Not Set';
            }
            
            if (data.cookies) {
                cookiesInput.value = data.cookies;
            } else {
                cookiesInput.value = 'Not Set';
            }
            
            if (data.valid) {
                const timeLeft = Math.floor(data.time_until_expiry / 60);
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong><i class="bi bi-check-circle"></i> Token is valid</strong><br>
                        Expires in ${timeLeft} minutes
                    </div>
                `;
            } else if (data.expired) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong><i class="bi bi-exclamation-circle"></i> Token expired</strong><br>
                        Please enter a new token below
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <strong><i class="bi bi-exclamation-triangle"></i> No token set</strong><br>
                        Please enter your Bearer token below
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Failed to check token status:', err);
        });
}

// simple hash function for privacy
function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = (hash << 5) - hash + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash.toString();
}

// UI Helpers
function toggleUpdateForm() {
    const card = document.getElementById('update-credentials-card');
    if (card.style.display === 'none') {
        card.style.display = 'block';
        // scroll to card
        card.scrollIntoView({ behavior: 'smooth' });
    } else {
        card.style.display = 'none';
    }
}

function copyToClipboard(id) {
    const input = document.getElementById(id);
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    navigator.clipboard.writeText(input.value).then(() => {
        const btn = input.nextElementSibling;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied';
        btn.classList.replace('btn-outline-primary', 'btn-success');
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.classList.replace('btn-success', 'btn-outline-primary');
        }, 1500);
    });
}

function decodeCurrentToken() {
    const token = document.getElementById('current-token').value;
    if (!token || token === 'Loading...' || token === 'Not Set') {
        document.getElementById('jwt-header').textContent = 'No token available to decode.';
        document.getElementById('jwt-payload').textContent = '';
        return;
    }

    try {
        const parts = token.split('.');
        if (parts.length !== 3) {
            throw new Error('Invalid JWT format');
        }

        const header = JSON.parse(atob(parts[0]));
        const payload = JSON.parse(atob(parts[1]));

        document.getElementById('jwt-header').textContent = JSON.stringify(header, null, 2);
        document.getElementById('jwt-payload').textContent = JSON.stringify(payload, null, 2);
    } catch (e) {
        document.getElementById('jwt-header').textContent = 'Error decoding token: ' + e.message;
        document.getElementById('jwt-payload').textContent = '';
    }
}

// Check if token matches history on input
document.getElementById('bearer-token').addEventListener('input', function(e) {
    const token = e.target.value.trim();
    if (!token) {
        document.getElementById('token-status-display').innerHTML = '';
        return;
    }
    
    const history = JSON.parse(localStorage.getItem('token_history') || '{}');
    const currentHash = hashString(token);
    
    // Check main history list too
    const listHistory = JSON.parse(localStorage.getItem('token_usage_history') || '[]');
    const isInList = listHistory.some(h => hashString(h.token) === currentHash);
    
    if (history.hash === currentHash || isInList) {
        const lastDate = new Date(history.date || new Date()); 
        const statusDiv = document.getElementById('token-status-display');
        
        statusDiv.innerHTML = `
            <div class="alert alert-info py-2">
                <strong><i class="bi bi-info-circle"></i> Info:</strong> 
                You have used this token before.
            </div>
        `;
    } else {
        document.getElementById('token-status-display').innerHTML = '';
    }
});

// handle token form submission
document.getElementById('token-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const token = document.getElementById('bearer-token').value.trim();
    const cookies = document.getElementById('cookies').value.trim();
    
    if (!token) {
        showNotification('Please enter a token', 'error');
        return;
    }
    
    // submit token and cookies
    const payload = { token };
    if (cookies) {
        payload.cookies = cookies;
    }
    
    fetch('/api/token/set', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            let message = data.message || 'Token saved successfully!';
            if (data.resumed_jobs && data.resumed_jobs > 0) {
                message += ` ${data.resumed_jobs} paused job(s) resumed!`;
            }
            showNotification(message, 'success');
            
            // Save to history
            const hash = hashString(token);
            const history = {
                hash: hash,
                date: new Date().toISOString()
            };
            localStorage.setItem('token_history', JSON.stringify(history));
            
            // Also save to recent list for orderbook
            let listHistory = JSON.parse(localStorage.getItem('token_usage_history') || '[]');
            listHistory = listHistory.filter(h => hashString(h.token) !== hash);
            listHistory.unshift({
                token: token,
                preview: token.slice(-6),
                date: new Date().toISOString()
            });
            if (listHistory.length > 5) listHistory.pop();
            localStorage.setItem('token_usage_history', JSON.stringify(listHistory));
            
            // Clear inputs and refresh status
            document.getElementById('bearer-token').value = '';
            document.getElementById('cookies').value = '';
            checkTokenStatus();
        } else {
            showNotification('Failed to save token: ' + data.error, 'error');
        }
    })
    .catch(err => {
        showNotification('Network error: ' + err.message, 'error');
    });
});

// load defaults
function loadDefaults() {
    const saved = localStorage.getItem('job_defaults');
    if (saved) {
        try {
            const defaults = JSON.parse(saved);
            document.getElementById('default-delay').value = defaults.delay || 3;
            document.getElementById('default-limit').value = defaults.limit || 50;
        } catch (e) {
            console.error('Failed to load defaults:', e);
        }
    }
}

// save defaults
document.getElementById('defaults-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const defaults = {
        delay: parseFloat(document.getElementById('default-delay').value),
        limit: parseInt(document.getElementById('default-limit').value)
    };
    
    localStorage.setItem('job_defaults', JSON.stringify(defaults));
    showNotification('Defaults saved!', 'success');
});

function showNotification(message, type) {
    // simple notification
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <i class="bi bi-${icon}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>

{% endblock %}
