{% extends "base.html" %}

{% block title %}Settings - Stockbit Running Trade Scraper{% endblock %}

{% block content %}
<div class="container">
    <h1>Settings</h1>
    
    <!-- Token Management -->
    <!-- Token Management -->
    
    <!-- Current Session Details -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Current Session Details</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">Current Bearer Token to be used in script</label>
                <div class="input-group">
                    <input type="text" class="form-control font-monospace" id="current-token" readonly value="Loading..." style="background-color: #f8f9fa;">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('current-token')">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Current Cookies to be used in script</label>
                <div class="input-group">
                    <input type="text" class="form-control font-monospace" id="current-cookies" readonly value="Loading..." style="background-color: #f8f9fa;">
                    <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('current-cookies')">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#tokenDecoder" aria-expanded="false" aria-controls="tokenDecoder" onclick="decodeCurrentToken()">
                    <i class="bi bi-code-square"></i> Decode JWT
                </button>
                <button class="btn btn-primary" type="button" onclick="toggleUpdateForm()">
                    <i class="bi bi-pencil-square"></i> Update Token & Cookies
                </button>
            </div>

            <div class="collapse mt-3" id="tokenDecoder">
                <div class="card card-body bg-light border-info">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted small text-uppercase">Header</h6>
                            <pre id="jwt-header" class="bg-white p-2 border rounded small" style="max-height: 200px; overflow: auto;"></pre>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted small text-uppercase">Payload</h6>
                            <pre id="jwt-payload" class="bg-white p-2 border rounded small" style="max-height: 200px; overflow: auto;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Login -->
    <div class="card mb-4 shadow-sm" id="auto-login-card">
        <div class="card-header bg-success text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-robot"></i> Auto Login</h5>
                <span class="badge bg-light text-dark" id="auto-login-badge">Ready</span>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                Solves reCAPTCHA v3 via 2Captcha API, then POSTs to Stockbit login endpoint.
                No browser needed ‚Äî pure server-side HTTP calls (~30s).
                <br><small id="captcha-key-status"><i class="bi bi-hourglass-split"></i> Checking 2Captcha API key...</small>
            </p>

            <div id="auto-login-result" style="display:none;" class="mb-3"></div>

            <div class="row g-2 mb-3">
                <div class="col-md-5">
                    <input type="email" class="form-control" id="auto-login-email" placeholder="Stockbit email">
                </div>
                <div class="col-md-5">
                    <input type="password" class="form-control" id="auto-login-password" placeholder="Password">
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-success" id="auto-login-btn" onclick="startAutoLogin()">
                        <i class="bi bi-play-circle"></i> Login
                    </button>
                </div>
            </div>

            <!-- Progress Log -->
            <div id="auto-login-progress" style="display:none;">
                <h6 class="text-muted"><i class="bi bi-terminal"></i> Progress</h6>
                <div id="auto-login-log" 
                     class="bg-dark text-success font-monospace p-3 rounded" 
                     style="max-height: 200px; overflow-y: auto; font-size: 0.85em;">
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Bot Status -->
    <div class="card mb-4 shadow-sm" id="telegram-status-card">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-telegram"></i> Telegram Bot Status</h5>
                <span class="badge bg-light text-dark" id="telegram-status-badge">Checking...</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Bot Running
                            <span id="telegram-running">...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Token Configured
                            <span id="telegram-token">...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Chat ID Configured
                            <span id="telegram-chat-id">...</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                         <li class="list-group-item d-flex justify-content-between align-items-center">
                            Bot Identity
                            <span id="telegram-identity">...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Job Queue Active
                            <span id="telegram-job-queue">...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Last Error
                            <span id="telegram-error" class="text-danger small text-end" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">-</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-3 d-flex justify-content-end">
                <button class="btn btn-outline-primary" id="telegram-test-btn" onclick="sendTelegramTest()">
                    <i class="bi bi-send"></i> Send Test Message
                </button>
            </div>
        </div>

    <!-- Manual Update (Hidden by default) -->
    <div class="card mt-4" id="update-credentials-card" style="display: none;">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-key"></i> Update Credentials</h5>
                <button type="button" class="btn-close btn-close-white" onclick="toggleUpdateForm()" aria-label="Close"></button>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>How to get your Bearer token:</strong>
                <ol>
                    <li>Login to <a href="https://stockbit.com/login" target="_blank">Stockbit.com</a> in your browser</li>
                    <li>Open Developer Tools (F12)</li>
                    <li>Go to the Network tab</li>
                    <li>Look for any API request (like to <code>exodus.stockbit.com</code>)</li>
                    <li>Find the <code>Authorization</code> header and copy the token (without the "Bearer " prefix)</li>
                </ol>
            </div>
            
            <div id="token-status-display" class="mb-3">
                <!-- will be filled by JS -->
            </div>
            
            <form id="token-form">
                <div class="mb-3">
                    <label for="bearer-token" class="form-label">Bearer Token:</label>
                    <textarea 
                        id="bearer-token" 
                        class="form-control" 
                        rows="4" 
                        placeholder="Paste your Bearer token here..."
                        required
                    ></textarea>
                    <small class="text-muted">
                        This is the JWT token from the Authorization header
                    </small>
                </div>
                
                <div class="mb-3">
                    <label for="cookies" class="form-label">Cookies (Optional, for Orderbook streaming):</label>
                    <textarea 
                        id="cookies" 
                        class="form-control" 
                        rows="3" 
                        placeholder="Paste your Cookie header here (e.g., from Postman)..."
                    ></textarea>
                    <small class="text-muted">
                        <strong>Optional but recommended for stable WebSocket connections.</strong> Copy the entire Cookie header from Postman or Browser DevTools. This helps keep orderbook connections alive for hours.
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Token & Cookies
                </button>
            </form>
        </div>
    </div>
    
    <!-- Job Defaults -->
    <div class="card mt-4">
        <div class="card-header">
            <h3>Job Defaults</h3>
        </div>
        <div class="card-body">
            <form id="defaults-form">
                <div class="mb-3">
                    <label for="default-delay" class="form-label">
                        Delay Between Requests (seconds):
                    </label>
                    <input 
                        type="number" 
                        id="default-delay" 
                        class="form-control" 
                        value="3" 
                        min="0" 
                        step="0.5"
                    >
                    <small class="text-muted">
                        Wait time between each API request (helps avoid rate limiting)
                    </small>
                </div>
                
                <div class="mb-3">
                    <label for="default-limit" class="form-label">
                        Records Per Request:
                    </label>
                    <input 
                        type="number" 
                        id="default-limit" 
                        class="form-control" 
                        value="50" 
                        min="1" 
                        max="200"
                    >
                    <small class="text-muted">
                        Number of records to fetch per request (max 200)
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Defaults
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// load token status on page load
document.addEventListener('DOMContentLoaded', () => {
    checkTokenStatus();
    loadDefaults();
    checkCaptchaConfig();
});

function checkCaptchaConfig() {
    const el = document.getElementById('captcha-key-status');
    fetch('/api/token/auto-login/config')
        .then(res => res.json())
        .then(data => {
            if (data.has_captcha_key) {
                el.innerHTML = `<span class="text-success"><i class="bi bi-check-circle-fill"></i> 2Captcha API key loaded (${data.captcha_key_masked})</span>`;
            } else {
                el.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle-fill"></i> 2Captcha API key not found ‚Äî add <code>TWOCAPTCHA_API_KEY</code> to .env</span>`;
            }
        })
        .catch(() => {
            el.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Could not check 2Captcha config</span>`;
        });
}

// ===== Auto Login =====
let autoLoginPollInterval = null;

function startAutoLogin() {
    const btn = document.getElementById('auto-login-btn');
    const badge = document.getElementById('auto-login-badge');
    const progressDiv = document.getElementById('auto-login-progress');
    const logDiv = document.getElementById('auto-login-log');
    const resultDiv = document.getElementById('auto-login-result');
    const email = document.getElementById('auto-login-email').value.trim();
    const password = document.getElementById('auto-login-password').value;

    if (!email || !password) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="alert alert-warning">Enter email and password first.</div>';
        return;
    }

    // Reset UI
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    badge.textContent = 'Running';
    badge.className = 'badge bg-warning text-dark';
    progressDiv.style.display = 'block';
    logDiv.innerHTML = '';
    resultDiv.style.display = 'none';

    fetch('/api/token/auto-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Start polling for status
            autoLoginPollInterval = setInterval(pollAutoLoginStatus, 1000);
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-circle"></i> Login';
                badge.textContent = 'Error';
                badge.className = 'badge bg-danger';
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${data.error}</div>`;
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-circle"></i> Login';
        badge.textContent = 'Error';
        badge.className = 'badge bg-danger';
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Network error: ${err.message}</div>`;
    });
}

function pollAutoLoginStatus() {
    fetch('/api/token/auto-login/status')
        .then(res => res.json())
        .then(data => {
            const logDiv = document.getElementById('auto-login-log');
            const badge = document.getElementById('auto-login-badge');
            const btn = document.getElementById('auto-login-btn');
            const resultDiv = document.getElementById('auto-login-result');

            // Update progress log
            logDiv.innerHTML = data.progress.map(p => `<div>‚Üí ${p}</div>`).join('');
            logDiv.scrollTop = logDiv.scrollHeight;

            const statusLabels = {
                'starting': 'üöÄ Starting...',
                'submitting_captcha': 'üì° Submitting to 2Captcha v3...',
                'waiting_captcha_solution': '‚è≥ Waiting for solver (~30s)...',
                'captcha_solved': '‚úÖ Captcha Solved!',
                'posting_login': 'üì§ Sending Login Request...',
                'processing_login_response': 'üì® Processing Response...',
                'setting_token': 'üíæ Saving Token...',
                'success': '‚úÖ Success',
                'error': '‚ùå Error',
                'idle': 'Ready'
            };
            badge.textContent = statusLabels[data.status] || data.status;

            // Check if done
            if (!data.running && data.result) {
                clearInterval(autoLoginPollInterval);
                autoLoginPollInterval = null;

                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-circle"></i> Login';

                if (data.result.success) {
                    badge.className = 'badge bg-success';
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> <strong>Token captured successfully!</strong><br>
                            Token: ${data.result.token_length} chars<br>
                            Cookies: ${data.result.has_cookies ? data.result.cookie_length + ' chars' : 'Not captured'}<br>
                            ${data.result.expires_at ? 'Expires: ' + new Date(data.result.expires_at).toLocaleString() : ''}
                        </div>`;
                    // Refresh token status
                    checkTokenStatus();
                } else {
                    badge.className = 'badge bg-danger';
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> <strong>Auto-login failed</strong><br>
                            ${data.result.error}
                        </div>`;
                }
            }
        })
        .catch(err => {
            console.error('Poll error:', err);
        });
}

function checkTokenStatus() {
    fetch('/api/token/status')
        .then(res => res.json())
        .then(data => {
            const statusDiv = document.getElementById('token-status-display');
            
            // Populate current session details
            const tokenInput = document.getElementById('current-token');
            const cookiesInput = document.getElementById('current-cookies');
            
            if (data.token) {
                tokenInput.value = data.token;
            } else {
                tokenInput.value = 'Not Set';
            }
            
            if (data.cookies) {
                cookiesInput.value = data.cookies;
            } else {
                cookiesInput.value = 'Not Set';
            }
            
            if (data.valid) {
                const timeLeft = Math.floor(data.time_until_expiry / 60);
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong><i class="bi bi-check-circle"></i> Token is valid</strong><br>
                        Expires in ${timeLeft} minutes
                    </div>
                `;
            } else if (data.expired) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong><i class="bi bi-exclamation-circle"></i> Token expired</strong><br>
                        Please enter a new token below
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <strong><i class="bi bi-exclamation-triangle"></i> No token set</strong><br>
                        Please enter your Bearer token below
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Failed to check token status:', err);
        });
}

// simple hash function for privacy
function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = (hash << 5) - hash + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash.toString();
}

// UI Helpers
function toggleUpdateForm() {
    const card = document.getElementById('update-credentials-card');
    if (card.style.display === 'none') {
        card.style.display = 'block';
        // scroll to card
        card.scrollIntoView({ behavior: 'smooth' });
    } else {
        card.style.display = 'none';
    }
}

function copyToClipboard(id) {
    const input = document.getElementById(id);
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    navigator.clipboard.writeText(input.value).then(() => {
        const btn = input.nextElementSibling;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied';
        btn.classList.replace('btn-outline-primary', 'btn-success');
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.classList.replace('btn-success', 'btn-outline-primary');
        }, 1500);
    });
}

function decodeCurrentToken() {
    const token = document.getElementById('current-token').value;
    if (!token || token === 'Loading...' || token === 'Not Set') {
        document.getElementById('jwt-header').textContent = 'No token available to decode.';
        document.getElementById('jwt-payload').textContent = '';
        return;
    }

    try {
        const parts = token.split('.');
        if (parts.length !== 3) {
            throw new Error('Invalid JWT format');
        }

        const header = JSON.parse(atob(parts[0]));
        const payload = JSON.parse(atob(parts[1]));

        document.getElementById('jwt-header').textContent = JSON.stringify(header, null, 2);
        document.getElementById('jwt-payload').textContent = JSON.stringify(payload, null, 2);
    } catch (e) {
        document.getElementById('jwt-header').textContent = 'Error decoding token: ' + e.message;
        document.getElementById('jwt-payload').textContent = '';
    }
}

// Check if token matches history on input
document.getElementById('bearer-token').addEventListener('input', function(e) {
    const token = e.target.value.trim();
    if (!token) {
        document.getElementById('token-status-display').innerHTML = '';
        return;
    }
    
    const history = JSON.parse(localStorage.getItem('token_history') || '{}');
    const currentHash = hashString(token);
    
    // Check main history list too
    const listHistory = JSON.parse(localStorage.getItem('token_usage_history') || '[]');
    const isInList = listHistory.some(h => hashString(h.token) === currentHash);
    
    if (history.hash === currentHash || isInList) {
        const lastDate = new Date(history.date || new Date()); 
        const statusDiv = document.getElementById('token-status-display');
        
        statusDiv.innerHTML = `
            <div class="alert alert-info py-2">
                <strong><i class="bi bi-info-circle"></i> Info:</strong> 
                You have used this token before.
            </div>
        `;
    } else {
        document.getElementById('token-status-display').innerHTML = '';
    }
});

// handle token form submission
document.getElementById('token-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const token = document.getElementById('bearer-token').value.trim();
    const cookies = document.getElementById('cookies').value.trim();
    
    if (!token) {
        showNotification('Please enter a token', 'error');
        return;
    }
    
    // submit token and cookies
    const payload = { token };
    if (cookies) {
        payload.cookies = cookies;
    }
    
    fetch('/api/token/set', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            let message = data.message || 'Token saved successfully!';
            if (data.resumed_jobs && data.resumed_jobs > 0) {
                message += ` ${data.resumed_jobs} paused job(s) resumed!`;
            }
            showNotification(message, 'success');
            
            // Save to history
            const hash = hashString(token);
            const history = {
                hash: hash,
                date: new Date().toISOString()
            };
            localStorage.setItem('token_history', JSON.stringify(history));
            
            // Also save to recent list for orderbook
            let listHistory = JSON.parse(localStorage.getItem('token_usage_history') || '[]');
            listHistory = listHistory.filter(h => hashString(h.token) !== hash);
            listHistory.unshift({
                token: token,
                preview: token.slice(-6),
                date: new Date().toISOString()
            });
            if (listHistory.length > 5) listHistory.pop();
            localStorage.setItem('token_usage_history', JSON.stringify(listHistory));
            
            // Clear inputs and refresh status
            document.getElementById('bearer-token').value = '';
            document.getElementById('cookies').value = '';
            checkTokenStatus();
        } else {
            showNotification('Failed to save token: ' + data.error, 'error');
        }
    })
    .catch(err => {
        showNotification('Network error: ' + err.message, 'error');
    });
});

// load defaults
function loadDefaults() {
    const saved = localStorage.getItem('job_defaults');
    if (saved) {
        try {
            const defaults = JSON.parse(saved);
            document.getElementById('default-delay').value = defaults.delay || 3;
            document.getElementById('default-limit').value = defaults.limit || 50;
        } catch (e) {
            console.error('Failed to load defaults:', e);
        }
    }
}

// save defaults
document.getElementById('defaults-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const defaults = {
        delay: parseFloat(document.getElementById('default-delay').value),
        limit: parseInt(document.getElementById('default-limit').value)
    };
    
    localStorage.setItem('job_defaults', JSON.stringify(defaults));
    showNotification('Defaults saved!', 'success');
});

function showNotification(message, type) {
    // simple notification
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <i class="bi bi-${icon}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>

<script>
// Telegram Bot Functions
function checkTelegramStatus() {
    fetch('/api/telegram/status')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updateTelegramUI(data);
            }
        })
        .catch(err => console.error('Failed to check telegram status', err));
}

function updateTelegramUI(data) {
    const badge = document.getElementById('telegram-status-badge');
    const btn = document.getElementById('telegram-test-btn');
    
    // Running status
    const runningEl = document.getElementById('telegram-running');
    if (data.running) {
        runningEl.innerHTML = '<span class="badge bg-success">Yes</span>';
        badge.className = 'badge bg-success';
        badge.textContent = 'Online';
        btn.disabled = false;
    } else {
        runningEl.innerHTML = '<span class="badge bg-danger">No</span>';
        badge.className = 'badge bg-secondary';
        badge.textContent = 'Offline';
        btn.disabled = true;
    }

    // Config status
    document.getElementById('telegram-token').innerHTML = data.token_configured ? 
        '<span class="text-success"><i class="bi bi-check-circle"></i> Configured</span>' : 
        '<span class="text-danger"><i class="bi bi-x-circle"></i> Missing</span>';
        
    document.getElementById('telegram-chat-id').innerHTML = data.chat_id_configured ? 
        `<span class="text-primary font-monospace small">${data.chat_id}</span>` : 
        '<span class="text-danger"><i class="bi bi-x-circle"></i> Missing</span>';

    // Bot Identity
    const identityEl = document.getElementById('telegram-identity');
    if (data.bot_info) {
        identityEl.innerHTML = `<a href="https://t.me/${data.bot_info.username}" target="_blank">@${data.bot_info.username}</a>`;
    } else {
        identityEl.textContent = '-';
    }
    
    // Job Queue
    document.getElementById('telegram-job-queue').innerHTML = data.job_queue_available ?
        '<span class="text-success"><i class="bi bi-check-circle"></i> Active</span>' :
        '<span class="text-warning" title="Install python-telegram-bot[job-queue]"><i class="bi bi-exclamation-triangle"></i> Inactive</span>';

    // Error
    const errorEl = document.getElementById('telegram-error');
    if (data.last_error) {
        errorEl.textContent = data.last_error;
        errorEl.title = data.last_error;
    } else {
        errorEl.textContent = 'None';
    }
}

function sendTelegramTest() {
    const btn = document.getElementById('telegram-test-btn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
    
    fetch('/api/telegram/test', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showNotification('Test message sent successfully!', 'success');
            } else {
                showNotification('Failed to send message: ' + (data.error || 'Unknown error'), 'error');
                checkTelegramStatus(); // Refresh status to show error
            }
        })
        .catch(err => {
            showNotification('Network error: ' + err.message, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    checkTelegramStatus();
    // Refresh status every 30 seconds
    setInterval(checkTelegramStatus, 30000);
});
</script>

{% endblock %}
