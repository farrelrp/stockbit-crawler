{% extends "base.html" %}

{% block title %}Jobs - Stockbit Scraper{% endblock %}

{% block content %}
<div class="jobs">
    <style>
        .chip-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            min-height: 100px;
            background: white;
            cursor: text;
        }
        
        .chip-container:focus-within {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .chip .close-btn {
            margin-left: 8px;
            cursor: pointer;
            color: #6c757d;
            font-weight: bold;
        }
        
        .chip .close-btn:hover {
            color: #dc3545;
        }

        .chip-input {
            border: none;
            outline: none;
            padding: 4px;
            flex: 1;
            min-width: 60px;
        }
        
        /* Historical Index Styles */
        .history-section {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px dashed #dee2e6;
        }
        
        .history-chip {
            display: inline-block;
            background: white;
            border: 1px solid #ced4da;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .history-chip:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .history-chip i {
            color: #28a745;
            margin-right: 4px;
        }
    </style>
    <h2>Jobs Management</h2>
    
    <!-- Create new job form -->
    <div class="section">
        <h3>Create New Job</h3>
        <form id="create-job-form" class="form">
            <div class="form-group">
                <label for="ticker-input">Stock Tickers</label>
                <!-- Hidden input to store actual value for form submission -->
                <textarea id="tickers" name="tickers" style="display: none;"></textarea>
                
                <!-- Chip Container -->
                <div class="chip-container" onclick="document.getElementById('ticker-input').focus()">
                    <input type="text" class="chip-input" id="ticker-input" placeholder="Type ticker & press Enter (e.g. BBCA) ..." autocomplete="off">
                </div>
                <small class="text-muted">Type a ticker and press Enter or Comma. Backspace to delete.</small>
                
                <!-- History / Quick Add -->
                <div class="history-section" id="history-section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <small><strong><i class="fas fa-history"></i> Recent & Saved Indices:</strong></small>
                        <button type="button" class="btn btn-sm btn-link text-danger" onclick="clearTickerHistory()" style="padding: 0; font-size: 0.8em;">Clear History</button>
                    </div>
                    <div id="history-chips">
                        <!-- Populated by JS -->
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="saveCurrentAsIndex()">
                            <i class="fas fa-save"></i> Save Current Selection as Index
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="from-date">From Date</label>
                    <input type="date" id="from-date" name="from_date" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="until-date">Until Date</label>
                    <input type="date" id="until-date" name="until_date" class="form-control" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="delay">Request Delay (seconds)</label>
                    <input type="number" id="delay" name="delay_seconds" value="3" 
                           min="0" max="60" step="0.5" class="form-control">
                    <small>Delay after each completed task (0 = no delay)</small>
                </div>
                
                <div class="form-group">
                    <label for="limit">Records Per Page</label>
                    <input type="number" id="limit" name="limit" value="50" 
                           min="10" max="200" step="10" class="form-control">
                    <small>How many trades per API request (max 200)</small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="parallel-workers">Parallel Workers üöÄ</label>
                    <input type="number" id="parallel-workers" name="parallel_workers" value="1" 
                           min="1" max="10" class="form-control">
                    <small>Process multiple stocks simultaneously (1-10 workers)</small>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create Job</button>
            </div>
        </form>
    </div>
    
    <!-- Jobs list -->
    <div class="section">
        <div class="section-header">
            <h3>All Jobs</h3>
            <button onclick="loadJobs()" class="btn btn-secondary">Refresh</button>
        </div>
        <div id="jobs-list" class="jobs-list">
            <div class="loading">Loading jobs...</div>
        </div>
    </div>
</div>

<!-- Job details modal -->
<div id="job-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>Job Details</h2>
            <span class="close" onclick="closeJobModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="job-details-content">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
let jobsRefreshInterval;
let currentTickers = new Set();

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadDefaults();
    initChipInput();
    loadTickerHistory();
});

// --- Chip Input Logic ---
function initChipInput() {
    const input = document.getElementById('ticker-input');
    const container = document.querySelector('.chip-container');
    
    // Focus input when clicking container
    container.addEventListener('click', () => input.focus());
    
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const value = input.value.trim().toUpperCase();
            if (value) {
                // Split by comma in case user pasted "A,B,C"
                const parts = value.split(/[\n,]+/);
                parts.forEach(part => {
                    const clean = part.trim();
                    if (clean) addTicker(clean);
                });
                input.value = '';
            }
        } else if (e.key === 'Backspace' && input.value === '' && currentTickers.size > 0) {
            // Remove last tag on backspace
            const chips = container.querySelectorAll('.chip');
            if (chips.length > 0) {
                const lastChip = chips[chips.length - 1];
                removeTicker(lastChip.dataset.ticker);
            }
        }
    });
    
    // Handle paste
    input.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const parts = text.split(/[\n,]+/);
        parts.forEach(part => {
            const clean = part.trim().toUpperCase();
            if (clean) addTicker(clean);
        });
        input.value = '';
    });
}

function addTicker(ticker) {
    if (currentTickers.has(ticker)) return;
    
    currentTickers.add(ticker);
    updateTickersInput();
    
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.ticker = ticker;
    chip.innerHTML = `
        ${ticker}
        <span class="close-btn" onclick="removeTicker('${ticker}')">&times;</span>
    `;
    
    const input = document.getElementById('ticker-input');
    input.parentNode.insertBefore(chip, input);
}

function removeTicker(ticker) {
    if (!currentTickers.has(ticker)) return;
    
    currentTickers.delete(ticker);
    updateTickersInput();
    
    const chip = document.querySelector(`.chip[data-ticker="${ticker}"]`);
    if (chip) chip.remove();
}

function updateTickersInput() {
    const textarea = document.getElementById('tickers');
    textarea.value = Array.from(currentTickers).join('\n');
}

// --- History Logic ---
function loadTickerHistory() {
    const history = JSON.parse(localStorage.getItem('ticker_history') || '[]');
    const container = document.getElementById('history-chips');
    const section = document.getElementById('history-section');
    
    if (history.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    container.innerHTML = history.map((item, index) => `
        <div class="history-chip" onclick="loadTickerSet(${index})">
            <i class="fas fa-layer-group"></i> ${item.name} 
            <span class="badge badge-light text-dark" style="font-size:0.8em; margin-left:4px;">${item.count}</span>
            <span onclick="event.stopPropagation(); deleteHistoryItem(${index})" style="margin-left:5px; color:#dc3545; font-weight:bold;">&times;</span>
        </div>
    `).join('');
}

function saveCurrentAsIndex() {
    if (currentTickers.size === 0) {
        showNotification('Add some tickers first!', 'warning');
        return;
    }
    
    const name = prompt("Enter a name for this index/watchlist (e.g. 'Banking', 'My Watchlist'):");
    if (!name) return;
    
    const history = JSON.parse(localStorage.getItem('ticker_history') || '[]');
    history.unshift({
        name: name,
        tickers: Array.from(currentTickers),
        count: currentTickers.size,
        date: new Date().toISOString()
    });
    
    // Keep max 20 items
    if (history.length > 20) history.pop();
    
    localStorage.setItem('ticker_history', JSON.stringify(history));
    loadTickerHistory();
    showNotification(`Saved "${name}" to history!`, 'success');
}

function loadTickerSet(index) {
    const history = JSON.parse(localStorage.getItem('ticker_history') || '[]');
    const item = history[index];
    
    if (item && item.tickers) {
        // Option: clear existing or append? Let's clear for "Index" behavior
        // But maybe user wants to merge. Let's confirm if current is not empty.
        if (currentTickers.size > 0) {
            if (!confirm(`Replace current tickers with "${item.name}"? Cancel to Append.`)) {
                // Append mode
                // No action needed, just add
            } else {
                // Replace mode
                currentTickers.clear();
                document.querySelectorAll('.chip').forEach(c => c.remove());
            }
        }
        
        item.tickers.forEach(t => addTicker(t));
        showNotification(`Loaded ${item.name}`, 'success');
    }
}

function deleteHistoryItem(index) {
    const history = JSON.parse(localStorage.getItem('ticker_history') || '[]');
    history.splice(index, 1);
    localStorage.setItem('ticker_history', JSON.stringify(history));
    loadTickerHistory();
}

function clearTickerHistory() {
    if (confirm('Clear all saved indices?')) {
        localStorage.removeItem('ticker_history');
        loadTickerHistory();
        showNotification('History cleared', 'success');
    }
}

// Load defaults from localStorage
function loadDefaults() {
    const delay = localStorage.getItem('default_delay') || '3';
    const limit = localStorage.getItem('default_limit') || '50';
    
    document.getElementById('delay').value = delay;
    document.getElementById('limit').value = limit;
}

// Create job
document.getElementById('create-job-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        tickers: document.getElementById('tickers').value,
        from_date: document.getElementById('from-date').value,
        until_date: document.getElementById('until-date').value,
        delay_seconds: document.getElementById('delay').value,
        limit: document.getElementById('limit').value,
        parallel_workers: document.getElementById('parallel-workers').value
    };
    
    fetch('/api/jobs/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification('Job created successfully!', 'success');
            this.reset();
            loadDefaults();
            loadJobs();
        } else {
            showNotification('Failed to create job: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(err => {
        showNotification('Request failed: ' + err.message, 'error');
    });
});

// Load all jobs
function loadJobs() {
    fetch('/api/jobs')
        .then(r => r.json())
        .then(data => {
            const jobs = data.jobs || [];
            const container = document.getElementById('jobs-list');
            
            if (jobs.length === 0) {
                container.innerHTML = '<div class="empty-state">No jobs yet. Create one above!</div>';
                return;
            }
            
            container.innerHTML = jobs.map(job => {
                const progress = job.progress || {};
                const percentage = progress.percentage || 0;
                
                return `
                    <div class="job-card">
                        <div class="job-header">
                            <div>
                                <span class="job-id">${job.job_id.substring(0, 8)}</span>
                                <span class="status-badge status-${job.status.toLowerCase()}">${job.status}</span>
                            </div>
                            <div class="job-actions">
                                ${job.status === 'RUNNING' ? 
                                    `<button onclick="pauseJob('${job.job_id}')" class="btn-icon">‚è∏</button>` : ''}
                                ${job.status === 'PAUSED' ? 
                                    `<button onclick="resumeJob('${job.job_id}')" class="btn-icon">‚ñ∂</button>` : ''}
                                ${job.status === 'RUNNING' || job.status === 'PAUSED' || job.status === 'QUEUED' ? 
                                    `<button onclick="cancelJob('${job.job_id}')" class="btn-icon">‚úï</button>` : ''}
                                <button onclick="showJobDetails('${job.job_id}')" class="btn-icon">‚Ñπ</button>
                            </div>
                        </div>
                        <div class="job-info">
                            <strong>Tickers:</strong> ${job.tickers.join(', ')}
                        </div>
                        <div class="job-info">
                            <strong>Period:</strong> ${job.from_date} to ${job.until_date}
                        </div>
                        <div class="job-info">
                            <strong>Created:</strong> ${new Date(job.created_at).toLocaleString()} ${job.parallel_workers > 1 ? `üöÄ ${job.parallel_workers}x parallel` : ''}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="job-stats">
                            ‚úì ${progress.completed || 0} completed &nbsp;
                            ‚ü≥ ${progress.running || 0} running &nbsp;
                            ‚úó ${progress.failed || 0} failed &nbsp;
                            ‚ãØ ${progress.pending || 0} pending
                        </div>
                    </div>
                `;
            }).join('');
        })
        .catch(err => {
            console.error('Failed to load jobs:', err);
        });
}

function pauseJob(jobId) {
    fetch(`/api/jobs/${jobId}/pause`, { method: 'POST' })
        .then(r => r.json())
        .then(() => {
            showNotification('Job paused', 'success');
            loadJobs();
        });
}

function resumeJob(jobId) {
    fetch(`/api/jobs/${jobId}/resume`, { method: 'POST' })
        .then(r => r.json())
        .then(() => {
            showNotification('Job resumed', 'success');
            loadJobs();
        });
}

function cancelJob(jobId) {
    if (!confirm('Are you sure you want to cancel this job?')) return;
    
    fetch(`/api/jobs/${jobId}/cancel`, { method: 'POST' })
        .then(r => r.json())
        .then(() => {
            showNotification('Job cancelled', 'warning');
            loadJobs();
        });
}

let jobDetailsInterval;

function showJobDetails(jobId) {
    const modal = document.getElementById('job-modal');
    const content = document.getElementById('job-details-content');
    
    modal.style.display = 'block';
    content.innerHTML = '<div class="loading">Loading job details...</div>';
    
    // clear any existing interval
    if (jobDetailsInterval) {
        clearInterval(jobDetailsInterval);
    }
    
    // load details immediately
    loadJobDetails(jobId, content);
    
    // refresh every 2 seconds if job is running
    jobDetailsInterval = setInterval(() => {
        loadJobDetails(jobId, content);
    }, 2000);
}

function loadJobDetails(jobId, content) {
    fetch(`/api/jobs/${jobId}`)
        .then(r => r.json())
        .then(job => {
            const progress = job.progress || {};
            
            // group tasks by ticker
            const tasksByTicker = {};
            job.tasks.forEach(task => {
                if (!tasksByTicker[task.ticker]) {
                    tasksByTicker[task.ticker] = [];
                }
                tasksByTicker[task.ticker].push(task);
            });
            
            content.innerHTML = `
                <div class="job-details">
                    <div class="detail-section">
                        <h3>Job Information</h3>
                        <div class="detail-row">
                            <strong>Job ID:</strong> ${job.job_id}
                        </div>
                        <div class="detail-row">
                            <strong>Status:</strong> 
                            <span class="status-badge status-${job.status.toLowerCase()}">${job.status}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Progress:</strong> ${progress.completed}/${progress.total} tasks
                        </div>
                        <div class="detail-row">
                            <strong>Created:</strong> ${new Date(job.created_at).toLocaleString()}
                        </div>
                        ${job.started_at ? `
                            <div class="detail-row">
                                <strong>Started:</strong> ${new Date(job.started_at).toLocaleString()}
                            </div>
                        ` : ''}
                        ${job.completed_at ? `
                            <div class="detail-row">
                                <strong>Completed:</strong> ${new Date(job.completed_at).toLocaleString()}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="detail-section">
                        <h3>Tasks by Ticker</h3>
                        ${Object.entries(tasksByTicker).map(([ticker, tasks]) => {
                            const tickerCompleted = tasks.filter(t => t.status === 'COMPLETED').length;
                            const tickerFailed = tasks.filter(t => t.status === 'FAILED').length;
                            
                            return `
                                <div class="ticker-tasks">
                                    <h4>${ticker} (${tickerCompleted}/${tasks.length} completed)</h4>
                                    <div class="tasks-grid">
                                        ${tasks.map(task => {
                                            let statusDisplay = task.status;
                                            let progressInfo = '';
                                            
                                            if (task.status === 'RUNNING' && task.current_page > 0) {
                                                statusDisplay = `RUNNING (Page ${task.current_page})`;
                                                progressInfo = task.records_fetched > 0 ? 
                                                    `<span class="task-count">üìä ${task.records_fetched} records so far...</span>` : '';
                                            } else if (task.records_fetched > 0) {
                                                progressInfo = `<span class="task-count">${task.records_fetched} records (${task.pages_fetched || 1} pages)</span>`;
                                            }
                                            
                                            return `
                                                <div class="task-item task-${task.status.toLowerCase()}">
                                                    <span class="task-date">${task.date}</span>
                                                    <span class="task-status">${statusDisplay}</span>
                                                    ${progressInfo}
                                                    ${task.error ? 
                                                        `<span class="task-error" title="${task.error}">‚ö†</span>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        })
        .catch(err => {
            content.innerHTML = `<div class="alert alert-error">Failed to load job details: ${err.message}</div>`;
        });
}

function closeJobModal() {
    document.getElementById('job-modal').style.display = 'none';
    
    // stop refreshing when modal closes
    if (jobDetailsInterval) {
        clearInterval(jobDetailsInterval);
        jobDetailsInterval = null;
    }
}

// Click outside modal to close
window.onclick = function(event) {
    const jobModal = document.getElementById('job-modal');
    if (event.target === jobModal) {
        closeJobModal();
    }
}

// Initialize
loadDefaults();
loadJobs();
jobsRefreshInterval = setInterval(loadJobs, 5000);

window.addEventListener('beforeunload', () => {
    if (jobsRefreshInterval) clearInterval(jobsRefreshInterval);
});
</script>
{% endblock %}

