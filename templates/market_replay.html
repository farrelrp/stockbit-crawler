{% extends "base.html" %}

{% block title %}Market Replay - {{ filename }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card bg-dark text-white">
        <div class="card-body p-3 d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <h4 class="m-0"><i class="bi bi-clock-history"></i> Market Replay</h4>
            <div class="input-group input-group-sm" style="width: 300px;">
              <select class="form-select bg-secondary text-white border-0" id="fileSelect">
                <!-- Populated by JS -->
                <option value="">Loading files...</option>
              </select>
              <button class="btn btn-primary" id="loadBtn" onclick="loadFile()">
                <i class="bi bi-upload"></i> Load File
              </button>
            </div>
          </div>

          <div id="playbackControls" style="display: none;">
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-success btn-sm" id="startBtn" onclick="startReplay()">
                <i class="bi bi-play-fill"></i> Start
              </button>
              <button class="btn btn-warning btn-sm" id="pauseBtn" onclick="pauseReplay()"
                style="display: none; color: white;">
                <i class="bi bi-pause-fill"></i> Pause
              </button>
              <button class="btn btn-info btn-sm" id="resumeBtn" onclick="resumeReplay()"
                style="display: none; color: white;">
                <i class="bi bi-play-fill"></i> Resume
              </button>
              <button class="btn btn-danger btn-sm" id="stopBtn" onclick="stopReplay()" disabled>
                <i class="bi bi-stop-fill"></i> Stop
              </button>

              <div class="input-group input-group-sm ms-2" style="width: 150px;">
                <span class="input-group-text bg-secondary text-white border-0">Speed</span>
                <input type="number" class="form-control bg-dark text-white border-secondary" id="speedInput"
                  value="1.0" step="0.5" min="0.1" onchange="updateSpeed()">
                <span class="input-group-text bg-secondary text-white border-0">x</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="statusPanel" class="mb-3">
    <div class="row">
      <div class="col-md-12">
        <div class="progress" style="height: 2px;" onclick="seekFromClick(event)">
          <div class="progress-bar bg-info" role="progressbar" id="progressBar" style="width: 0%"></div>
        </div>
        <div class="d-flex justify-content-between mt-1 text-muted small">
          <span id="elapsedText">0s</span>
          <span id="progressBarText">0%</span>
        </div>
      </div>
    </div>
    <div class="row mt-2 text-center text-white small">
      <div class="col-md-2">
        STATUS: <span id="statusText" class="badge bg-secondary">Idle</span>
      </div>
      <div class="col-md-3">
        PROGRESS: <span id="progressText">0 / 0</span>
      </div>
      <div class="col-md-2">
        SPEED: <span id="speedText">1.0x</span>
      </div>
      <div class="col-md-3">
        BUFFER: <span id="stateSizeText">0</span>
      </div>
      <div class="col-md-2">
        <span id="updateIndicator" class="badge bg-success" style="display:none">UPDATED</span>
      </div>
    </div>
  </div>

  <div id="alertContainer"></div>

  <!-- Perspective Viewer Container -->
  <div id="viewerContainer" style="height: 70vh; position: relative; display: none;">
    <div class="d-flex justify-content-between align-items-center mb-1 px-2"
      style="background: #2a2a2a; border-radius: 4px 4px 0 0;">
      <small class="text-muted">Perspective Viewer</small>
      <div class="row text-center" style="font-size: 0.875rem; font-weight: 600">
        <div class="col-6" style="color: #28a745">
          <i class="bi bi-arrow-up-circle-fill"></i> BIDS
        </div>
        <div class="col-6" style="color: #dc3545">
          <i class="bi bi-arrow-down-circle-fill"></i> OFFERS
        </div>
      </div>
    </div>
    <perspective-viewer id="viewer"></perspective-viewer>
  </div>
</div>

<!-- Load Perspective LOCALLY as MODULES -->
<link rel="stylesheet" href="{{ url_for('static', filename='js/perspective/themes.css') }}" />
<script type="module">
  import perspective from "{{ url_for('static', filename='js/perspective/perspective.js') }}";
  import "{{ url_for('static', filename='js/perspective/perspective-viewer.js') }}";
  import "{{ url_for('static', filename='js/perspective/perspective-viewer-datagrid.js') }}";
  import "{{ url_for('static', filename='js/perspective/perspective-viewer-d3fc.js') }}";

  // Expose perspective to global window for existing code
  window.perspective = perspective;

  // Signal that libraries are loaded
  console.log("[MODULE] Perspective modules loaded via ES import");
  window.dispatchEvent(new CustomEvent('perspective-ready'));
</script>

<script>
  console.log("[LOAD] Starting Market Replay initialization...");

  let viewer = null;
  let statusInterval = null;
  let fileMetadata = null;
  let perspectiveReady = false;

  // Wait for the custom event or check periodically
  window.addEventListener('perspective-ready', () => {
    console.log("[OK] Perspective module ready event received");
    perspectiveReady = true;
    if (typeof init === 'function') init();
  });

  // Initialize
  async function init() {
    if (init.done) return;
    init.done = true;

    try {
      console.log("[INIT] Starting init sequence...");

      // Double check availability
      if (!window.perspective) {
        console.log("[INIT] Waiting for window.perspective...");
        await new Promise(r => {
          const i = setInterval(() => {
            if (window.perspective) { clearInterval(i); r(); }
          }, 100);
        });
      }

      console.log("[INIT] Loading file list...");
      await loadFileList();

      console.log("[INIT] Setting up Perspective viewer...");
      viewer = document.getElementById("viewer");

      // Register the D3FC plugin explicitly if needed (though import usually does it)
      if (viewer.registerPlugin) {
        try { await viewer.registerPlugin("d3fc"); } catch (e) { }
      }

      const websocket = await window.perspective.websocket(
        "ws://localhost:8888/websocket"
      );
      console.log("[OK] Connected to Perspective WebSocket");

      const table = await websocket.open_table("orderbook");
      console.log("[OK] Opened orderbook table");

      await viewer.load(table);
      console.log("[OK] Loaded table into viewer");

      await viewer.restore({
        plugin: "Datagrid",
        columns: ["price", "freq", "lot_size", "change", "timestamp"],
        split_by: ["side"],
        sort: [["price", "desc"]],
        aggregates: {
          "timestamp": "last",
          "price": "avg",
          "freq": "last",
          "lot_size": "last",
          "change": "last"
        }
      });
      console.log("[OK] Configured viewer");

      // Hook up UI updates
      const view = viewer.getView();
      view.on_update(() => {
        const indicator = document.getElementById("updateIndicator");
        if (indicator) {
          indicator.style.display = "inline-block";
          setTimeout(() => { indicator.style.display = "none"; }, 200);
        }
      });

      startStatusPolling();

    } catch (error) {
      console.error("[ERROR] Initialization failed:", error);
      showAlert("Init failed: " + error.message, "danger");
    }
  }

  async function loadFileList() {
    try {
      const response = await fetch("/api/replay/files");
      const data = await response.json();
      if (data.success) {
        const select = document.getElementById("fileSelect");
        select.innerHTML = '<option value="">-- Select a file --</option>';
        data.files.forEach((file) => {
          const option = document.createElement("option");
          option.value = file.path;
          option.textContent = file.filename;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error("Failed to load file list:", error);
    }
  }

  window.loadFile = async function () {
    const select = document.getElementById("fileSelect");
    const csvPath = select.value;
    if (!csvPath) return;

    try {
      console.log("[ACTION] Loading file:", csvPath);
      const response = await fetch("/api/replay/load", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ csv_path: csvPath }),
      });
      const data = await response.json();
      if (data.success) {
        fileMetadata = data;
        console.log(`[SUCCESS] Loaded ${data.total_rows} rows`);
        showAlert(`Loaded ${data.total_rows} rows. Ready to play.`, "success");

        document.getElementById("playbackControls").style.display = "block";
        document.getElementById("viewerContainer").style.display = "block";
      } else {
        showAlert("Load failed: " + data.error, "danger");
      }
    } catch (e) {
      console.error("Load failed", e);
      showAlert("Load error: " + e.message, "danger");
    }
  }

  // Playback controls implementation
  window.startReplay = async function () {
    let speed = parseFloat(document.getElementById("speedInput").value);
    if (isNaN(speed) || speed <= 0) speed = 1.0;

    try {
      console.log("[ACTION] Starting replay with speed:", speed);
      const response = await fetch("/api/replay/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json; charset=utf-8",
          "Accept": "application/json"
        },
        body: JSON.stringify({ speed_multiplier: speed }),
      });
      if ((await response.json()).success) {
        setControlState("running");
        showAlert("Replay started", "success");
      }
    } catch (error) { showAlert("Error: " + error.message, "danger"); }
  };

  window.pauseReplay = async function () {
    const response = await fetch("/api/replay/pause", { method: "POST" });
    if ((await response.json()).success) setControlState("paused");
  };

  window.resumeReplay = async function () {
    const response = await fetch("/api/replay/resume", { method: "POST" });
    if ((await response.json()).success) setControlState("running");
  };

  window.stopReplay = async function () {
    const response = await fetch("/api/replay/stop", { method: "POST" });
    if ((await response.json()).success) {
      setControlState("stopped");
      showAlert("Replay stopped", "info");
    }
  };

  function setControlState(state) {
    const start = document.getElementById("startBtn");
    const pause = document.getElementById("pauseBtn");
    const resume = document.getElementById("resumeBtn");
    const stop = document.getElementById("stopBtn");

    if (state === "running") {
      start.disabled = true; stop.disabled = false;
      pause.style.display = "inline-block"; resume.style.display = "none";
    } else if (state === "paused") {
      pause.style.display = "none"; resume.style.display = "inline-block";
    } else {
      start.disabled = false; stop.disabled = true;
      pause.style.display = "inline-block"; resume.style.display = "none";
    }
  }

  window.updateSpeed = async function () {
    const multiplier = parseFloat(document.getElementById("speedInput").value);
    await fetch("/api/replay/speed", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ multiplier }),
    });
    document.getElementById("speedText").textContent = multiplier + "x";
  };

  window.seekFromClick = async function (event) {
    const progressBar = document.getElementById("progressBar");
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percent = clickX / rect.width;

    if (fileMetadata && fileMetadata.total_rows) {
      const position = Math.floor(percent * fileMetadata.total_rows);
      await fetch("/api/replay/seek", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ position }),
      });
      showAlert(`Seeked to row ${position}`, "info");
    }
  };

  async function updateStatus() {
    try {
      const response = await fetch("/api/replay/status");
      const data = await response.json();

      if (data.success && data.status) {
        const status = data.status;
        let statusText = status.running ? (status.paused ? "PAUSED" : "RUNNING") : "Ready";
        document.getElementById("statusText").textContent = statusText;

        if (status.total_rows > 0) {
          document.getElementById("progressText").textContent = `${status.current_index} / ${status.total_rows}`;
          document.getElementById("progressBar").style.width = status.progress_percent + "%";
          document.getElementById("progressBarText").textContent = status.progress_percent.toFixed(1) + "%";
        }

        document.getElementById("speedText").textContent = status.speed_multiplier + "x";
        document.getElementById("elapsedText").textContent = Math.floor(status.elapsed_time) + "s";
        document.getElementById("stateSizeText").textContent = status.state_size;
      }
    } catch (error) { }
  }

  function startStatusPolling() {
    if (statusInterval) clearInterval(statusInterval);
    statusInterval = setInterval(updateStatus, 500);
  }

  function showAlert(message, type) {
    const container = document.getElementById("alertContainer");
    if (!container) return;
    const alert = document.createElement("div");
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    setTimeout(() => { alert.remove(); }, 5000);
  }
</script>
{% endblock %}